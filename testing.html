<!DOCTYPE html>
<html>
<head>
    <title>SpeccyPlays Endless Sky save file viewer</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/CSS/styles.css" />
</head>
<body>
    <button onclick="openFile()">Open a file</button>
    <input id="inp" type='file' style="visibility:hidden;" onchange="readFile(event)" />
    <div id="contents">
    <ul id="result"></ul>
    </div>
    <script>
        function openFile() {
            document.getElementById('inp').click();
        }
        function readFile(e) {
            var file = e.target.files[0];
            if (!file) return;
            var reader = new FileReader();

            let output = {
                conditions : {},
                ships : []
            }
            reader.onload = function(e) {
                console.log("file loaded");
                let target = document.getElementById('result');
                const data = e.target.result.split('\n');
                //used to help with nesting
                let topLevelLine = "";
                for (line in data){
                    //a lot of repeated code but slight differences between some of the values
                    const text = data[line];
                    const numOfTabs = numberOfTabs(text);
                    const newLine = text.slice(0, text.indexOf(' ')).toLowerCase();
                    if (numOfTabs == 0){
                        topLevelLine = text;
                    }
                    if (newLine.includes("pilot") && numOfTabs == 0){
                        const tidiedText = text.trim().replace(/"/g, '')
                        const key = tidiedText.slice(0, tidiedText.indexOf(' '));
                        const value = tidiedText.slice(tidiedText.indexOf(' ') + 1).trim();
                        if (!output[key]){
                            output[key] = [];
                        }
                        output[key].push(value);
                    }
                    if (newLine.includes("mission") && numOfTabs == 0){
                        const tidiedText = text.trim().replace(/"/g, '')
                        const key = tidiedText.slice(0, tidiedText.indexOf(' '));
                        const value = tidiedText.slice(tidiedText.indexOf(' ') + 1).trim();
                        if (!output[key]){
                            output[key] = [];
                        }
                        output[key].push(value);
                    }
                    if (newLine.includes("conditions")){
                        //seems pointless but stops extra value being added
                    }
                    else if (topLevelLine.includes("conditions")){
                        //groups the different missions a bit better
                        const tidiedText = text.trim().replace(/"/g, '')
                        const key = tidiedText.slice(0, tidiedText.indexOf(':'));
                        const value = tidiedText.slice(tidiedText.indexOf(':') + 1).trim();
                        if (!output.conditions[key]){
                            output.conditions[key] = [] 
                        }
                        output.conditions[key].push(value);
                    }
                    if (newLine.includes("visited") && numOfTabs == 0){
                        const tidiedText = text.trim().replace(/"/g, '')
                        const key = tidiedText.slice(0, tidiedText.indexOf(' '));
                        const value = tidiedText.slice(tidiedText.indexOf(' ') + 1).trim();
                        if (!output[key]){
                            output[key] = [];
                        }
                        output[key].push(value);
                    }
                    if (newLine.includes("ship") && numOfTabs == 0){
                        output.ships.push(text);
                    }
                    else if (topLevelLine.includes("ship")){
                        output.ships.push(text);
                    }
                }

                //The output is all key:array apart from confitions which has another level of keys before the array
                const resultDiv = document.getElementById("result");
                const keys = Object.keys(output);
                const specialText = 'conditions'
                keys.forEach ( (key) => {
                    if (key != specialText){
                        const newDiv = document.createElement('button');
                        //newDiv.innerHTML(element.toString());
                        newDiv.setAttribute('class', 'tablinks');
                        newDiv.innerHTML = key.toString();
                        if (Array.isArray(output[key])){
                            output[key].forEach( (item) => {
                                //create tab content
                            })
                        }
                        resultDiv.appendChild(newDiv);
                    }
                    else {
                        const conditionKeys = Object.keys(output[specialText]);
                        console.log(conditionKeys);
                        conditionKeys.forEach( (item) => {
                            const newDiv = document.createElement('button');
                            newDiv.setAttribute('class', 'tablinks');
                            newDiv.innerHTML = item.toString();
                            resultDiv.appendChild(newDiv);
                        })
                    }
                })
            }
            reader.readAsText(file)
        }
        function numberOfTabs(text) {
            return text.match(/^\s*/)[0].length;
            }
    </script>
</body>
</html>