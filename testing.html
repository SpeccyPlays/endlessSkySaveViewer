<!DOCTYPE html>
<html>
  <head>
    <title>SpeccyPlays Endless Sky save file viewer</title>
    <link rel="icon" type="image/x-icon" href="/images/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/CSS/styles.css" />
  </head>
  <body>
    <button onclick="openFile()">Open a file</button>
    <input
      id="inp"
      type="file"
      style="visibility: hidden"
      onchange="readFile(event)"
    />
    <div id="filecontents">
      <div id="tabs">
        <div id="content"></div>
      </div>
      
    </div>
    <script>
      function openFile() {
        document.getElementById("inp").click();
      }
      function readFile(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();

        reader.onload = function (e) {
          console.log("file loaded");
          const data = e.target.result.split("\n");
          //used to help with nesting
          const output = formatData(data);
          displayData(output);
        };
        reader.readAsText(file);
      }
      function formatData(data) {
        let output = {
          conditions: {},
          ships: [],
        };
        let topLevelLine = "";
        for (line in data) {
          //a lot of repeated code but slight differences between some of the values
          const text = data[line];
          const numOfTabs = numberOfTabs(text);
          const newLine = text.slice(0, text.indexOf(" ")).toLowerCase();
          if (numOfTabs == 0) {
            topLevelLine = text;
          }
          if (newLine.includes("pilot") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          if (newLine.includes("mission") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          if (newLine.includes("conditions")) {
            //seems pointless but stops extra value being added
          } else if (topLevelLine.includes("conditions")) {
            //groups the different missions a bit better
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(":"));
            const value = tidiedText.slice(tidiedText.indexOf(":") + 1).trim();
            if (!output.conditions[key]) {
              output.conditions[key] = [];
            }
            output.conditions[key].push(value);
          }
          if (newLine.includes("visited") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          if (newLine.includes("ship") && numOfTabs == 0) {
            output.ships.push(text);
          } else if (topLevelLine.includes("ship")) {
            output.ships.push(text);
          }
        }
        return output;
      }
      function displayData(output) {
        /*
          Section to set up the html
          The output is all key:array apart from confitions which has another level of keys before the array
          */
        const resultDiv = document.getElementById("tabs");
        const keys = Object.keys(output);
        const specialText = "";
        keys.forEach((key) => {
          if (key != specialText) {
            const keyDiv = document.createElement("button");
            keyDiv.setAttribute("class", "tablinks");
            keyDiv.onclick = function (e) {
              openTab(event, key);
            };
            keyDiv.innerHTML = key.toString();
            resultDiv.appendChild(keyDiv);
            if (Array.isArray(output[key])) {
              try {
                output[key].forEach((item) => {
                  //create tab content
                  setSubContent(item, keyDiv, resultDiv);
                });
              } catch (e) {
                console.log("There was an error :", e);
              }
            } else if (checkIfObject(output[key])) {
              try {
                const conditionKeys = Object.keys(output[key]);
                conditionKeys.forEach((item) => {
                  const newDiv = document.createElement("button");
                  newDiv.setAttribute("class", "tablinks");
                  newDiv.innerHTML = item.toString();
                  resultDiv.appendChild(keyDiv);
                });
              } catch (e) {
                console.log("There was an error :", e);
              }
            }
          }
        });
      }
      function setSubContent(item, keyDiv, resultDiv) {
        const newDiv = document.createElement("p");
        newDiv.setAttribute("class", "tabcontent");
        newDiv.setAttribute("id", keyDiv);
        newDiv.innerHTML = item.toString();
        resultDiv.appendChild(keyDiv);
      }
      function numberOfTabs(text) {
        return text.match(/^\s*/)[0].length;
      }
      function checkIfObject(obj) {
        return typeof obj === "object" && obj !== null;
      }
      function openTab(evt, tabName) {
        console.log("Click registered");
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        //document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }
    </script>
  </body>
</html>
