<!DOCTYPE html>
<html>
  <head>
    <title>SpeccyPlays Endless Sky save file viewer</title>
    <link rel="icon" type="image/x-icon" href="./public/images/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/public/CSS/styles.css" />
  </head>
  <body>
    <div class="header">
      <button onclick="openFile()">Open a file</button>
      <input
        id="inp"
        type="file"
        style="visibility: hidden"
        onchange="readFile(event)"
      />
    </div>
    <div id="filecontents">
      <div id="pilotname"></div>
      <div id="tabs"></div>
      <div id="content"></div>
    </div>
    <script>
      function openFile() {
        document.getElementById("inp").click();
      }
      function readFile(e) {
        var file = e.target.files[0];
        if (!file) return;
        var reader = new FileReader();

        reader.onload = function (e) {
          console.log("file loaded");
          removedChildren();
          const data = e.target.result.split("\n");
          const output = formatData(data);
          displayData(output);
        };
        reader.readAsText(file);
      }
      function formatData(data) {
        let output = {
          conditions: {},
        };
        let topLevelLine = "";
        for (line in data) {
          //a lot of repeated code but slight differences between some of the values
          const text = data[line];
          const numOfTabs = numberOfTabs(text);
          const newLine = text.slice(0, text.indexOf(" ")).toLowerCase();
          if (numOfTabs == 0) {
            topLevelLine = text;
          }
          if (newLine.includes("pilot") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          if (newLine.includes("mission") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          if (newLine.includes("reputation") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = {};
            }
          } else if (topLevelLine.includes("reputation")) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.lastIndexOf(" "));
            const value = tidiedText.slice(
              tidiedText.lastIndexOf(" ") + 1,
              tidiedText.length
            );
            if (!output.reputation[key]) {
              output.reputation[key] = [];
            }
            output.reputation[key].push(value);
          }
          if (newLine.includes("conditions")) {
            //seems pointless but stops extra value being added
            if (!output.conditions) {
              output.conditions = {};
            }
          } else if (topLevelLine.includes("conditions")) {
            //groups the different missions a bit better
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(":"));
            const value = tidiedText.slice(tidiedText.indexOf(":") + 1).trim();
            if (!output.conditions[key]) {
              output.conditions[key] = [];
            }
            output.conditions[key].push(value);
          }
          if (newLine.includes("visited") && numOfTabs == 0) {
            const tidiedText = text.trim().replace(/"/g, "");
            const key = tidiedText.slice(0, tidiedText.indexOf(" "));
            const value = tidiedText.slice(tidiedText.indexOf(" ") + 1).trim();
            if (!output[key]) {
              output[key] = [];
            }
            output[key].push(value);
          }
          /*
          commenting out ship as I think the game makes ship data easily viewable
          if (newLine.includes("ship") && numOfTabs == 0) {
            if (!output.ships){
              output.ships = [];
            }
            output.ships.push(text);
          } else if (topLevelLine.includes("ship")) {
            output.ships.push(text);
          }*/
        }
        return output;
      }
      function displayData(output) {
        /*
          Section to set up the html
          The output is all key:array apart from confitions which has another level of keys before the array
          */
        const tabsDiv = document.getElementById("tabs");
        const contentDiv = document.getElementById("content");
        //add pilot as heading and remove from ouput so doesn't get added as a tab
        if (output.pilot && output.pilot.length > 0) {
          const pilotDiv = document.getElementById("pilotname");
          const heading = document.createElement("h3");
          heading.innerText = "Pilot: " + output.pilot[0];
          pilotDiv.appendChild(heading);
          delete output.pilot;
        }
        const keys = Object.keys(output);
        keys.forEach((key) => {
          //create the buttons
          const keyDiv = document.createElement("button");
          keyDiv.setAttribute("class", "tablinks");
          keyDiv.setAttribute("name", key);
          keyDiv.onclick = function (e) {
            openTab(e, e.target.name);
          };
          keyDiv.innerHTML = key.toString();
          tabsDiv.appendChild(keyDiv);
          //create the content divs
          const keyContentDiv = document.createElement("div");
          keyContentDiv.setAttribute("id", key);
          keyContentDiv.setAttribute("class", "tabcontent");
          //hide by default or they all show - can be handled in CSS later
          keyContentDiv.style.display = "none";
          contentDiv.appendChild(keyContentDiv);
          if (Array.isArray(output[key])) {
            try {
              output[key].forEach((item) => {
                //create tab content
                setSubContent(item, keyDiv, keyContentDiv);
              });
            } catch (e) {
              console.log("There was an error :", e);
            }
          } else if (checkIfObject(output[key])) {
            try {
              const conditionKeys = Object.keys(output[key]);
              conditionKeys.forEach((item) => {
                setSubContent(item, keyDiv, keyContentDiv);
              });
            } catch (e) {
              console.log("There was an error :", e);
            }
          }
        });
      }
      function setSubContent(item, keyDiv, contentDiv) {
        const newDiv = document.createElement("p");
        newDiv.innerHTML = item.toString();
        contentDiv.appendChild(newDiv);
      }
      function numberOfTabs(text) {
        return text.match(/^\s*/)[0].length;
      }
      function checkIfObject(obj) {
        return typeof obj === "object" && obj !== null;
      }
      function openTab(evt, tabName) {
        console.log("Click registered ", tabName);
        // Declare all variables
        var i, tabcontent, tablinks;

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }
      function removedChildren() {
        //remove children of high level divs
        //to remove duplication if another file is opened
        const highLevelDivs = ["pilotname", "tabs", "content"];
        highLevelDivs.forEach((divName) => {
          const element = document.getElementById(divName);
          while (element.firstChild) {
            element.removeChild(element.firstChild);
          }
        });
      }
    </script>
  </body>
</html>
